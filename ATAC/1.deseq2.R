# Load necessary packages
library(rtracklayer)
library(GenomicRanges)
library(DESeq2)
library(ChIPseeker)
library(TxDb.Mmusculus.UCSC.mm10.knownGene)
library(org.Mm.eg.db)
library(clusterProfiler)
library(ggplot2)
library(dplyr)
library(pheatmap)
library(RColorBrewer)
library(ggrepel)

# Read the signal data generated by bigWigAverageOverBed
cmp_rep1_signal <- read.table("CMP_rep1_signal.tab", header=FALSE)
cmp_rep2_signal <- read.table("CMP_rep2_signal.tab", header=FALSE)
cfue_rep1_signal <- read.table("CFUE_rep1_signal.tab", header=FALSE)
cfue_rep2_signal <- read.table("CFUE_rep2_signal.tab", header=FALSE)

# The first column (V1) now contains the peak ID in the format "chr_start_end"
# Check the first few IDs to confirm format
cat("First few peak IDs:", head(cmp_rep1_signal$V1), "\n")

# Create count matrix using the mean signal values (column 5)
count_matrix <- cbind(
  CMP_rep1 = cmp_rep1_signal$V5,
  CMP_rep2 = cmp_rep2_signal$V5,
  CFUE_rep1 = cfue_rep1_signal$V5,
  CFUE_rep2 = cfue_rep2_signal$V5
)

# Set row names based on peak IDs (column 1) - these are now in chr_start_end format
rownames(count_matrix) <- cmp_rep1_signal$V1

# Round to integers for DESeq2 (DESeq2 requires integer counts)
count_matrix <- round(count_matrix)

# Save raw count matrix for reference
write.csv(count_matrix, file = "ATAC_counts_matrix_signal_based.csv")

# Create sample information
coldata <- data.frame(
  condition = factor(c("CMP", "CMP", "CFUE", "CFUE")),
  row.names = colnames(count_matrix)
)

# Create DESeq2 dataset
dds <- DESeqDataSetFromMatrix(countData = count_matrix,
                              colData = coldata,
                              design = ~ condition)

# Filter low count peaks (optional but recommended)
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]

# Run DESeq2 analysis
dds <- DESeq(dds)

# Get results for CFUE vs CMP comparison
results <- results(dds, contrast = c("condition", "CFUE", "CMP"))

# Order results by adjusted p-value
results <- results[order(results$padj),]

# Convert results to data frame for easier manipulation
results_df <- as.data.frame(results)

# Add status column for visualization
results_df$status <- "Not Sig"
results_df$status[results_df$padj < 0.05 & results_df$log2FoldChange > 0] <- "Up"
results_df$status[results_df$padj < 0.05 & results_df$log2FoldChange < 0] <- "Down"

# Define colors for plots
colors <- c("Up" = "red", "Down" = "blue", "Not Sig" = "gray")

# Check number of significant differential peaks
cat("Differential peaks from DESeq2 (FDR < 0.05):", sum(results_df$padj < 0.05, na.rm = TRUE), "\n")
cat("Upregulated in CFUE:", sum(results_df$status == "Up"), "\n")
cat("Downregulated in CFUE:", sum(results_df$status == "Down"), "\n")

# Save results
write.csv(results_df, "CFUE_vs_CMP_bedtools_replicated_peaks_DESeq2_results.csv")

# Generate MA plot using ggplot2
ma_plot <- ggplot(results_df, aes(x = baseMean, y = log2FoldChange, color = status)) +
  geom_point(size = 1, alpha = 0.7) +
  scale_color_manual(values = colors) +
  labs(title = "MA Plot: CFUE vs CMP ATAC-seq Peaks",
       x = "Average Peak Abundance (log2)",
       y = "Log2 Fold Change (CFUE/CMP)") +
  theme_bw() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.grid.minor = element_blank()) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black", size = 0.5) +
  ylim(c(-5, 5)) +
  scale_x_log10()

# Save the MA plot
ggsave("CFUE_vs_CMP_MA_plot_DESeq2.png", ma_plot, width = 8, height = 6, dpi = 300)
ggsave("CFUE_vs_CMP_MA_plot_DESeq2.pdf", ma_plot, width = 8, height = 6)

# Read the merged peaks with peak names for annotations
all_peaks_merged <- import.bed("all_replicated_merged.withpkname.bed")

# Use ChIPseeker to annotate all peaks with gene information
txdb <- TxDb.Mmusculus.UCSC.mm10.knownGene
all_peaks_annotation <- annotatePeak(all_peaks_merged, 
                                     tssRegion = c(-3000, 3000),
                                     TxDb = txdb, 
                                     annoDb = "org.Mm.eg.db")

# Convert the annotation to a data frame
annotation_df <- as.data.frame(all_peaks_annotation)

# Create a mapping from peak ID to gene symbol
peak_to_gene <- data.frame(
  peak_id = annotation_df$seqnames,
  gene_symbol = annotation_df$SYMBOL,
  stringsAsFactors = FALSE
)

# Handle NAs in gene symbols (replace with peak ID)
peak_to_gene$gene_symbol[is.na(peak_to_gene$gene_symbol)] <- peak_to_gene$peak_id[is.na(peak_to_gene$gene_symbol)]

# Create a named vector for easy lookup
gene_symbols <- setNames(peak_to_gene$gene_symbol, peak_to_gene$peak_id)

# Add gene symbols to the results data frame
results_df$gene_symbol <- gene_symbols[rownames(results_df)]

# Create volcano plot with gene labels for top genes
# Find top 20 genes by significance and absolute fold change
top_genes <- results_df %>%
  filter(padj < 0.05) %>%
  mutate(abs_log2FC = abs(log2FoldChange)) %>%
  arrange(padj, desc(abs_log2FC)) %>%
  head(20)

# Create the volcano plot
volcano_plot <- ggplot(results_df, aes(x = log2FoldChange, y = -log10(padj), color = status)) +
  geom_point(size = 1.5, alpha = 0.7) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "darkgray") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "darkgray") +
  scale_color_manual(values = colors) +
  geom_text_repel(data = top_genes, 
                  aes(label = gene_symbol),
                  box.padding = 0.5,
                  max.overlaps = 20,
                  size = 3) +
  labs(title = "Volcano Plot: CFUE vs CMP ATAC-seq Peaks",
       x = "Log2 Fold Change (CFUE/CMP)",
       y = "-log10(Adjusted p-value)") +
  theme_bw() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        panel.grid.minor = element_blank())

# Save the volcano plot
ggsave("CFUE_vs_CMP_volcano_plot_DESeq2.png", volcano_plot, width = 8, height = 6, dpi = 300)
ggsave("CFUE_vs_CMP_volcano_plot_DESeq2.pdf", volcano_plot, width = 8, height = 6)

# Get significant differential peak IDs
significant_peak_ids <- rownames(results_df)[results_df$padj < 0.05]
up_peak_ids <- rownames(results_df)[results_df$status == "Up"]
down_peak_ids <- rownames(results_df)[results_df$status == "Down"]

# Get significant peak ranges by matching peak IDs
significant_peaks_ranges <- all_peaks_merged[match(significant_peak_ids, all_peaks_merged$name)]
up_peaks_ranges <- all_peaks_merged[match(up_peak_ids, all_peaks_merged$name)]
down_peaks_ranges <- all_peaks_merged[match(down_peak_ids, all_peaks_merged$name)]

# Create a function for peak annotation and visualization
annotate_and_visualize <- function(peaks, label, txdb = TxDb.Mmusculus.UCSC.mm10.knownGene) {
  if(length(peaks) == 0) return(NULL)
  
  # Annotate peaks
  anno <- annotatePeak(peaks, tssRegion=c(-3000, 3000),
                       TxDb=txdb, annoDb="org.Mm.eg.db")
  
  # Plot annotation pie chart
  png(paste0(label, "_peak_annotation_DESeq2.png"), width=800, height=600)
  plotAnnoPie(anno)
  dev.off()
  
  # Plot distance to TSS
  png(paste0(label, "_distance_to_TSS_DESeq2.png"), width=800, height=600)
  plotDistToTSS(anno)
  dev.off()
  
  # Save annotation data
  anno_df <- as.data.frame(anno)
  write.csv(anno_df, paste0(label, "_chromatin_regions_with_annotations_DESeq2.csv"))
  
  return(anno)
}

# Annotate peaks for each category
sig_anno <- annotate_and_visualize(significant_peaks_ranges, "differential")
up_anno <- annotate_and_visualize(up_peaks_ranges, "upregulated")
down_anno <- annotate_and_visualize(down_peaks_ranges, "downregulated")

# Function to extract genes with symbols from annotation
get_genes_with_symbols <- function(anno) {
  if(is.null(anno)) return(data.frame(geneId=character(0), symbol=character(0)))
  
  genes_df <- data.frame(
    geneId = anno@anno$geneId,
    symbol = anno@anno$SYMBOL
  ) %>% 
    filter(!is.na(geneId)) %>%
    distinct()
  
  return(genes_df)
}

# Extract genes with symbols
up_genes_df <- get_genes_with_symbols(up_anno)
down_genes_df <- get_genes_with_symbols(down_anno)
all_genes_df <- rbind(up_genes_df, down_genes_df) %>% distinct()

# Save gene lists with symbols
write.csv(up_genes_df, "upregulated_genes_with_symbols_DESeq2.csv", row.names=FALSE)
write.csv(down_genes_df, "downregulated_genes_with_symbols_DESeq2.csv", row.names=FALSE)
write.csv(all_genes_df, "differential_genes_with_symbols_DESeq2.csv", row.names=FALSE)

# Save significant peaks as BED files using a data frame approach
# For all significant peaks
sig_peaks_df <- data.frame(
  chr = as.character(seqnames(significant_peaks_ranges)),
  start = start(significant_peaks_ranges) - 1,  # BED is 0-based
  end = end(significant_peaks_ranges),
  name = significant_peaks_ranges$name,
  score = round((results_df$log2FoldChange[match(significant_peaks_ranges$name, rownames(results_df))] + 5) * 100),
  strand = as.character(strand(significant_peaks_ranges))
)
write.table(sig_peaks_df, "significant_differential_peaks_DESeq2.bed", 
            quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)

# For upregulated peaks
up_peaks_df <- data.frame(
  chr = as.character(seqnames(up_peaks_ranges)),
  start = start(up_peaks_ranges) - 1,  # BED is 0-based
  end = end(up_peaks_ranges),
  name = up_peaks_ranges$name,
  score = 1000,  # Fixed score for upregulated
  strand = as.character(strand(up_peaks_ranges))
)
write.table(up_peaks_df, "upregulated_peaks_DESeq2.bed", 
            quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)

# For downregulated peaks
down_peaks_df <- data.frame(
  chr = as.character(seqnames(down_peaks_ranges)),
  start = start(down_peaks_ranges) - 1,  # BED is 0-based
  end = end(down_peaks_ranges),
  name = down_peaks_ranges$name,
  score = 1000,  # Fixed score for downregulated
  strand = as.character(strand(down_peaks_ranges))
)
write.table(down_peaks_df, "downregulated_peaks_DESeq2.bed", 
            quote = FALSE, sep = "\t", row.names = FALSE, col.names = FALSE)

# Function for GO enrichment analysis and visualization
perform_go_analysis <- function(genes, label) {
  if(length(genes) <= 10) return(NULL)
  
  # Perform GO enrichment
  ego <- enrichGO(gene = genes,
                  OrgDb = org.Mm.eg.db,
                  ont = "BP",
                  pAdjustMethod = "BH",
                  pvalueCutoff = 0.05,
                  qvalueCutoff = 0.05,
                  readable = TRUE)
  
  if(is.null(ego) || nrow(ego) == 0) return(NULL)
  
  # Save GO results
  write.csv(ego, paste0("GO_enrichment_", label, "_DESeq2.csv"))
  
  # Create dotplot visualization
  p <- dotplot(ego, showCategory=20, title=paste0("GO Biological Process - ", label))
  
  # Save as PNG
  png(paste0("GO_enrichment_", label, "_DESeq2.png"), width=1000, height=800)
  print(p)
  dev.off()
  
  # Save as PDF
  pdf(paste0("GO_enrichment_", label, "_DESeq2.pdf"), width=10, height=13)
  print(p)
  dev.off()
  
  return(ego)
}

# Perform GO analysis for each gene set
ego_up <- perform_go_analysis(up_genes_df$geneId, "up_regulated")
ego_down <- perform_go_analysis(down_genes_df$geneId, "down_regulated")
go_bp <- perform_go_analysis(all_genes_df$geneId, "all_diff_genes")
